[TOC]





# CPU 的组成与工作流程

# CPU 的功能

1.指令控制：控制指令的执行顺序。

2.操作控制：产生指令执行所需的操作控制信号。

3.时间控制：对操作控制信号进行时序控制。

4.数据加工：实现指令约定的数据运算。

5.中断处理：实现异常及中断的检测及处理。

## CPU 的组成

**基本组成**





**寄存器组织**  

1.用户可见寄存器  
	(1)数据寄存器：用于存放指令的操作数。位数等于机器字长。  
	(2)地址寄存器：用于存放操作数地址或指令地址。位数等于程序逻辑地址长度/段内地址长度。  
	(3)通用寄存器：既可用于存放数据，又可用于存放地址。提高了寄存器的使用效率。  
	(4)状态寄存器：用于存放程序运行的状态。

2.专用寄存器  
	(1)程序计数器(PC)：用于存放指令地址。  
	(2)指令寄存器(IR)：用于存放当前指令内容。  
	(3)存储器地址寄存器(MAR)：用于存放CPU外部访问的部件地址。  
	(4)存储器数据集村求(MDR)：用于存放CPU从外部读出的数据或者将要向外部写入的数据。  
	(5)控制寄存器：用于控制CPU的工作模式及操作方式。

## CPU 的工作流程

指令周期：将CPU取出一条指令并执行所需的时间。  

单周期CPU：指令周期由一个时钟周期组成。  
多周期CPU：指令周期由多个时钟周期组成。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_1.png" alt="image-20200828151549706" style="zoom:50%;" />

## 指令的执行过程

指令执行过程有**取指令**、**分析指令**、**执行指令**3个步骤。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_2.png" alt="image-20200828152057107" style="zoom:50%;" />

1.取指令  
2.指令操作译码  
3.取操作数  
4.数据操作  
5.保存结果  
6.指令地址计算

（为了缩短指令周期，PC增量操作通常放在取指令步骤中完成；转移型指令的下条指令地址计算通常放在取操作数、数据操作步骤中完成。）













# 数据通路的组织

## 数据通路的组成

数据通路：指令执行过程中数据所经过的路径及路径上的部件。  
数据通路由**功能部件**、**数据通路结构**两部分呢组成。  

**数据通路结构**

1.总线结构数据通路：多个部件输出端通过同一个信号线连接到其他部件输入端。  
①单总线数据通路：同时只能实现1个数据传送操作。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_3.png" alt="image-20200829125945175" style="zoom:50%;" />

②多总线数据通路：同时可实现多个数据传送操作。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_4.png" alt="image-20200829130234247" style="zoom:50%;" />

2.专用结构数据通路：部件每个输入端都通过不同信号线连接到其他部件输出端。可以同时进行所有数据的传输。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_5.png" alt="image-20200902083345921" style="zoom:50%;" />

**数据通路的微操作及其控制**

**微操作(uop)**：CPU内部的原子操作  
**微操作控制信号/微操作命令(uOPCmd)**：实现uOP的部件控制信号。  
**节拍**：完成一个uOP的时间  
**uOP序列**：多个uOP通过不同的节拍信号进行时序控制

1.寄存器间传送  
2.存储器读/存储器写  
3.算逻运算  















# 控制器的组成

控制器的主要功能：指令控制、操作控制、时间控制、中断处理。

## 控制器的基本结构

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_6.png" alt="image-20200902092259089" style="zoom:50%;" />

控制器类型：



|          |  硬布线控制器  |  微程序控制器  |
| :------: | :------------: | :------------: |
| 循环周期 | 1个CPU工作周期 | 1个微指令周期  |
| 产生方法 |  组合逻辑电路  | 微指令执行部件 |

①1个微指令的功能等价于1个uOPs  
②1个CPU工作周期需执行n条微指令（微程序）



















# 硬布线控制器

根据指令的要求、当前的时序及外部和内部的状态，按时间的顺序发送一系列操作控制信号。  
它由复杂的组合逻辑 门电路和一些触发器构成，因此又称**组合逻辑控制器**。

 ## 时序系统  
①指令周期  
②机器周期 ：每个机器周期内可完成若干微操作。  
③节拍：每个节拍内可完成一个或几个需同时执行的微操作。    
④工作脉冲  
【⑤时钟周期：时钟脉冲信号的宽度。】

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_7.png" alt="image-20200902110234014" style="zoom:50%;" />

一条指令通常分为3个机器周期：**取指周期**、**间址周期**、**执行周期。**  
①取指周期的微操作命令

```
PC->MAR				现行指令地址->MAR
1->R				命令存储器读
M(MAR)->MDR			现行指令从存储器中读至MDR
MDR->IR				现行指令->IR
OP(IR)->CU			指令的操作码->CU
(PC)+1->PC			形成下一条指令的地址
```

②间址周期的微操作命令

```
Ad(IR)->MAD			将指令中的地址码（形式地址）->MAR
1->R				命中存储器读
M(MAR)->MDR			将有效地址从存储器读至MDR
```

③执行周期的微操作命令：命令视不同指令而定。

**时序信号的控制方式**：  
1.同步控制方式  
	系统有一个统一的时钟，所有的控制信号均来自这个统一的时钟信号。  
	通常以最长的微操作序列和最繁琐的微操作作为标准，采取完全统一的、具有相同时间间隔和相同数目的节拍作为机器周期。  
	此时，**一个节拍等于一个时钟周期。**

2.异步控制方式  
	不存在基准时钟信号，每个微操作的时序只受专门的联络信号控制。  
	每个节拍的值不固定，取决于应答信号何时到达。  
	此时，**一个节拍等于多个时钟周期。**

3.联合控制方式   
	同步控制与异步控制的结合，每个微操作的时序受基准时钟信号与应答信号的共同控制。





















# 微程序控制器

将每条机器指令编写成一个微程序，每个微程序包含若干微指令，每条微指令对应一个或几个微操作命令。

## 微程序控制的基本概念

①**微操作**：计算机中最基本的、不可再分解的操作。  
	**微命令**：控制部件向执行部件发出的各种控制命令。  
		微命令是微操作的控制信号，微操作是微命令的执行过程。  
		相容性微命令：可以同时产生、共同完成某一些微操作。  
		互斥性微命令：机器中不允许同时出现的微命令。    
③**微指令**：若干微命令的集合。  
	一般包含： 1)操作控制字段：用于产生某一步操作所需的各种操作控制信号。  
						2)顺序控制字段：用于控制产生下一条要执行的微指令地址。  
④**微周期**：从控制存储器中读取一条微指令并执行相应的微操作所需的时间。  
⑤**程序**：指令的有序集合。  
	**微程序**：微指令的有序集合。  
		一条指令的功能由一段微程序来实现。  

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_8.png" alt="image-20200903141324911" style="zoom:50%;" />



## 微指令格式

**1.微指令编码方式**  
(1)直接编码方式  
	操作控制字段由多个位组成，每一位定义一个微命令。操作控制字段的长度等于所有微命令的个数。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_9.png" alt="image-20200903152111170" style="zoom:50%;" />

(2)字段直接编码方式   
	操作控制字段由多个子字段组成，每个子字段可以定义一组微命令。操作控制字段的长度等于各子字段长度之和。  
	互斥性微命令组合在同一字段中，相容性微命令组合在不同字段中。  
	每个子字段的长度为：【公式中，1对应的编码表示该子字段定义的微命令全部无效。】
$$
log_2(定义的微命令数+1)
$$
<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_10.png" alt="image-20200903153014951" style="zoom:50%;" />

(3)字段间接编码方式  
	操作控制字段由多个子字段组成，部分子字段的某些编码不能独立地定义微命令，需要与其他子字段的编码联合起来定义一个微命令。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_11.png" alt="image-20200903154040155" style="zoom:50%;" />

**2.微地址的形成方式**  
当前微指令形成下条微指令地址的方法。  
(1)计数器法：下条微指令地址由uAR的技术功能隐含产生，适用于顺序型微指令。  
(2)下址法：下条微指令地址由顺序控制字段直接给出，适用于顺序型、跳转型微指令。  
(3)测试网络法  
(4)硬件产生法

**3.微指令的格式**  
(1)水平型微指令    
同时可以执行多个微命令。操作控制字段通常采用**定长的**直接编码、字段直接编码、字段间接编码。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_12.png" alt="image-20200903160108368" style="zoom:50%;" />

(2)垂直型微指令  
	同时只能执行一个微命令。操作控制字段和顺序控制字段是**变长的**。  





|          |                         硬布线控制器                         |                         微程序控制器                         |
| :------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| 工作原理 | 微操作控制信号由组合逻辑电路根据当前的指令码、状态和时序，即时产生 | 微操作控制信号以微程序的形式存放在控制存储器中，执行指令时读出即可 |
| 执行速度 |                              慢                              |                              块                              |
|  规整性  |                            较规整                            |                         繁琐、不规整                         |
| 应用场合 |                           CISC CPU                           |                           RISC CPU                           |
| 易扩充性 |                          易扩充修改                          |                             困难                             |











# 指令流水线

## 指令流水线的概述

**1.指令流水线的概念**  
将指令执行过程划分成若干个阶段，每个阶段由专门的功能部件来实现，使得每条指令可以一次通过各个阶段（部件），各个阶段可以同时处理不同指令的操作。 

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_13.png" alt="image-20200903171252733" style="zoom:50%;" />

工作原理：每条指令按序通过各个流水段，多条指令的执行过程相互重叠。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_14.png" alt="image-20200903171436989" style="zoom:50%;" />

**2.流水线的性能**    
(1)吞吐率：单位时间内流水线所完成任务或输出结果的数量。  
假设指令流水线有m个段，拍长为Δt，连续执行n条指令，则流水线的吞吐率为：
$$
T_p= \frac{n}{T_{流水}} = \frac{n}{mΔt+(n-1)Δt}
$$
(2)加速比：程序采用流水方式执行与采用串行方式执行的速度之比。  
假设指令流水线有m个段，拍长为Δt，连续执行n条指令，则流水线的加速比为：
$$
S =  \frac{T_{串行}}{T_{流水}} =  \frac{mΔt \times n}{mΔt+(n-1)Δt} =  \frac{mn}{n+m-1}
$$

(3)效率：流水线中部件的使用时间与整个运行时间的比值。  
假设指令流水线有m个段，拍长为Δt，连续执行n条指令，则流水线的加速比为：
$$
E = \frac{n个任务所占时空区}{n个任务总的时空区} = \frac{n \times mΔt}{m(m+n-1)Δt} = \frac{n}{m+n-1}
$$

**3.流水线的分类**  
(1)单功能流水线：只能实现一种固定的专门功能。  
多功能流水线：通过各段间的不同连接方式可以同时或不同时地实现多种功能。  
(2)静态流水线：各个段同时只能连接成一种功能进行工作。  
	动态流水线：各个段同时可以连接成不同功能进行工作。  
(3)线性流水线：各个段串行连接，新任务在每一拍都可以流入。  
	非线性流水线：各个段除串行连接外，还存在反馈回路，新任务只能在没有冲突时才能流入。（常用与递归操作）  
(4)顺序流水线：任务流出次序与流入次序完全相同。  
	乱序流水线：任务留出次序与流入次序可以不同。  
(5)标量流水线：处理标量数据，如定点数、浮点数，每一拍可以流入一个任务。  
	向量流水线：处理向量数据，如数组，若干怕才可以流入一个任务。

**4.指令流水线的冒险处理**  
(1)结构冒险

(2)数据冒险  
	①阻塞法  
	②转发法  
	③乱序执行法

(3)控制冒险  
	①阻塞法  
	②分支预测法  
	③延迟分支法

**5.指令流水线的并行技术**  
1.超级流水线  
	在一个时间周期内再分段，在一个时钟周期内一个功能部件使用多次。  

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_15.png" alt="image-20200904161130174" style="zoom:50%;" />

2.超标量流水线  
	每个时钟周期内可并发多条独立指令，即以并行操作方式将两条或多条指令编译并执行。

<img src="C:\Users\GaoWei\Desktop\新建文件夹\图片\5_16.png" alt="image-20200904161419607" style="zoom:50%;" />